<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head th:replace="admin/_fragments :: head(~{::title})">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Publish Blog</title>
</head>
<body class="bg-gray-50">

  <!--Navigation-->
  <nav th:replace="admin/_fragments :: menu(1)"></nav>

  <!--Secondary Navigation-->
  <div class="bg-white border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-end space-x-4 py-3">
        <a th:href="@{/admin/blogs/input}" 
           class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">Publish</a>
        <a th:href="@{/admin/blogs}" 
           class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 transition-colors">List</a>
      </div>
    </div>
  </div>

  <!--Main Content-->
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <form id="blog-form" 
          th:object="${blog}" 
          th:action="@{/admin/blogs}" 
          method="post" 
          class="bg-white rounded-lg border border-gray-100 p-6 space-y-6">
      
        <input type="hidden" name="published" th:value="*{published}">
        <input type="hidden" name="id" th:value="*{id}">
      <input type="hidden" id="blog-tagIds" th:value="*{tagIds}">
      <input type="hidden" id="blog-createTime" th:value="${blog.createTime != null ? #dates.format(blog.createTime, 'yyyy-MM-dd HH:mm:ss') : ''}">

      <!--Title and Type-->
      <div class="flex gap-4">
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 mb-2">Title <span class="text-red-500">*</span></label>
          <div class="flex gap-2">
            <!-- Hidden native select for form submission -->
            <select name="flag" 
                    id="flag-select-hidden"
                    style="display: none;">
              <option value="原创" th:selected="*{flag} == '原创'">原创</option>
              <option value="转载" th:selected="*{flag} == '转载'">转载</option>
              <option value="翻译" th:selected="*{flag} == '翻译'">翻译</option>
            </select>
            <!-- Custom dropdown -->
            <div class="relative" id="flag-dropdown">
              <div class="custom-select-trigger bg-white px-4 py-2.5 text-sm border border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors flex items-center justify-between"
                   id="flag-trigger">
                <span class="text-gray-900" id="flag-display">Original</span>
                <svg class="w-4 h-4 text-gray-400 transition-transform ml-2" id="flag-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </div>
              <div class="custom-select-options hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg"
                   id="flag-options">
                <div class="custom-select-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                     data-value="原创"
                     data-display="Original"
                     onclick="selectFlag('原创', 'Original')">
                  Original
                </div>
                <div class="custom-select-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                     data-value="转载"
                     data-display="Repost"
                     onclick="selectFlag('转载', 'Repost')">
                  Repost
              </div>
                <div class="custom-select-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                     data-value="翻译"
                     data-display="Translation"
                     onclick="selectFlag('翻译', 'Translation')">
                  Translation
                </div>
              </div>
            </div>
            <input type="text" 
                   name="title" 
                   placeholder="Enter blog title" 
                   th:value="*{title}"
                   required
                   class="flex-1 px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-colors">
          </div>
          </div>
        </div>

      <!--Publish Time-->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Publish Time <span class="text-xs text-gray-500 font-normal">(Optional, leave empty to use current time)</span></label>
        <input type="datetime-local" 
               id="publishTime" 
               name="publishTime" 
               class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-colors">
        <p class="mt-1 text-xs text-gray-500">You can customize the blog publish time, leave empty to use current time</p>
      </div>

      <!--Content Editor-->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Content <span class="text-red-500">*</span></label>
        <div id="md-content" style="z-index: 1 !important;">
          <textarea placeholder="Blog content" 
                    name="content" 
                    style="display: none" 
                    th:text="*{content}"></textarea>
        </div>
            </div>

      <!--Category and Tags-->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Category <span class="text-red-500">*</span></label>
          <!-- Hidden native select for form submission -->
          <select name="type.id" 
                  id="type-select-hidden"
                  required
                  style="display: none;">
            <option value="">Select category</option>
            <option th:each="type : ${types}" 
                    th:value="${type.id}" 
                    th:text="${type.name}">Error Log</option>
          </select>
          <!-- Custom dropdown -->
          <div class="relative" id="type-dropdown">
            <div class="custom-select-trigger bg-white w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors flex items-center justify-between"
                 id="type-trigger">
              <span class="text-gray-500" id="type-display">Select category</span>
              <svg class="w-4 h-4 text-gray-400 transition-transform" id="type-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
            <div class="custom-select-options hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto"
                 id="type-options">
              <div class="custom-select-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                   data-value=""
                   onclick="selectType('')">
                Select category
          </div>
              <div th:each="type : ${types}" 
                   class="custom-select-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer"
                   th:data-value="${type.id}"
                   th:data-name="${type.name}"
                   th:onclick="'selectType(\'' + ${type.id} + '\')'">
                <span th:text="${type.name}">Error Log</span>
          </div>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
          <!-- Hidden native multi-select for form submission -->
          <select name="tagIds" 
                  id="tagIds-hidden"
                  multiple
                  style="display: none;">
            <option th:each="tag : ${tags}" 
                    th:value="${tag.id}" 
                    th:text="${tag.name}">java</option>
          </select>
          <!-- Custom multi-select dropdown -->
          <div class="relative" id="tag-dropdown">
            <div class="custom-multiselect-trigger bg-white w-full px-4 py-2.5 text-sm border border-gray-300 rounded-lg cursor-pointer hover:border-gray-400 transition-colors flex items-center justify-between min-h-[42px]"
                 id="tag-trigger">
              <div class="flex-1 flex flex-wrap gap-1.5" id="tag-selected-display">
                <span class="text-gray-500" id="tag-placeholder">Select tags</span>
        </div>
              <svg class="w-4 h-4 text-gray-400 transition-transform flex-shrink-0 ml-2" id="tag-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
    </div>
            <div class="custom-multiselect-options hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto"
                 id="tag-options">
              <div th:each="tag : ${tags}" 
                   class="custom-multiselect-option px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 cursor-pointer flex items-center"
                   th:data-tag-id="${tag.id}"
                   th:data-tag-name="${tag.name}">
                <input type="checkbox" 
                       th:value="${tag.id}"
                       class="tag-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2"
                       onchange="toggleTag(this)">
                <span th:text="${tag.name}">java</span>
  </div>
            </div>
          </div>
        </div>
      </div>

      <!--Featured Image-->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Featured Image <span class="text-xs text-gray-500 font-normal">(Optional - will use first image from content if not provided)</span></label>
        <div class="space-y-2">
          <div class="flex gap-2">
            <input type="text" 
                   name="firstPicture" 
                   id="firstPicture-input"
                   th:value="*{firstPicture}" 
                   placeholder="Image URL or upload file"
                   class="flex-1 px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-colors">
            <input type="file" 
                   id="firstPicture-file"
                   accept="image/*"
                   class="hidden">
            <button type="button" 
                    id="upload-image-btn"
                    class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
              Upload
            </button>
          </div>
          <div id="image-preview" class="hidden">
            <img id="preview-img" src="" alt="Preview" class="max-w-xs h-32 object-cover rounded-lg border border-gray-200">
          </div>
        </div>
        <p class="mt-1 text-xs text-gray-500">If no image is provided, the first image from the article content will be used automatically.</p>
      </div>

      <!--Location (Optional)-->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Location <span class="text-xs text-gray-500 font-normal">(Optional)</span></label>
        <input type="text" 
               name="location" 
               th:value="*{location}" 
               placeholder="e.g., Taipei, Beijing, Shanghai"
               class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-colors">
        <p class="mt-1 text-xs text-gray-500">This location will be displayed after the author and time on the blog detail page</p>
        </div>

      <!--Description-->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Description <span class="text-xs text-gray-500 font-normal">(Optional)</span></label>
        <textarea name="description" 
                  th:text="*{description}" 
                  placeholder="Blog description..." 
                  maxlength="200"
                  rows="3"
                  class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-colors"></textarea>
        <p class="mt-1 text-xs text-gray-500">Maximum 200 characters (optional)</p>
          </div>

      <!--Options-->
      <div class="flex flex-wrap gap-6">
        <label class="flex items-center">
          <input type="checkbox" 
                 id="recommend" 
                 name="recommend" 
                 th:checked="*{recommend}"
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">Recommended</span>
        </label>
        
        <label class="flex items-center">
          <input type="checkbox" 
                 id="shareStatement" 
                 name="shareStatement" 
                 th:checked="*{shareStatement}"
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">Repost Statement</span>
        </label>
        
        <label class="flex items-center">
          <input type="checkbox" 
                 id="appreciation" 
                 name="appreciation" 
                 th:checked="*{appreciation}"
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">Appreciation</span>
        </label>
        
        <label class="flex items-center">
          <input type="checkbox" 
                 id="commentabled" 
                 name="commentabled" 
                 th:checked="*{commentabled}"
                 class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
          <span class="ml-2 text-sm text-gray-700">Comments</span>
        </label>
        </div>

      <!--Error Message-->
      <div id="error-message" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
        <p class="text-sm text-red-800"></p>
        </div>

      <!--Buttons-->
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
        <button type="button" 
                onclick="window.history.go(-1)" 
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
          Back
        </button>
        <button type="button" 
                id="save-btn" 
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
          Save
        </button>
        <button type="button" 
                id="publish-btn" 
                class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition-colors">
          Publish
        </button>
      </div>
    </form>
    </div>

  <!--Footer-->
  <footer th:replace="admin/_fragments :: footer"></footer>

  <!-- Scripts -->
  <th:block th:replace="admin/_fragments :: script"></th:block>

  <script>
    // Initialize Markdown editor
    var contentEditor;
    $(function() {
      contentEditor = editormd("md-content", {
        width   : "100%",
        height  : 640,
        syncScrolling : "single",
        path    : "/lib/editormd/lib/"
      });

      // Initialize flag dropdown
      initFlagDropdown();
      
      // Initialize category dropdown
      initTypeDropdown();
      
      // Initialize tag multi-select dropdown
      initTagDropdown();
      
      // Initialize publish time selector (edit mode)
      initPublishTime();
      
      // Initialize image upload
      initImageUpload();
    });
    
    // Initialize image upload functionality
    function initImageUpload() {
      const uploadBtn = $('#upload-image-btn');
      const fileInput = $('#firstPicture-file');
      const imageInput = $('#firstPicture-input');
      const preview = $('#image-preview');
      const previewImg = $('#preview-img');
      
      // Click upload button to trigger file input
      uploadBtn.on('click', function() {
        fileInput.click();
      });
      
      // Handle file selection
      fileInput.on('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          return;
        }
        
        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.attr('src', e.target.result);
          preview.removeClass('hidden');
        };
        reader.readAsDataURL(file);
        
        // Upload file
        const formData = new FormData();
        formData.append('file', file);
        
        uploadBtn.prop('disabled', true).text('Uploading...');
        
        $.ajax({
          url: '/admin/upload/image',
          method: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function(response) {
            if (response.success) {
              imageInput.val(response.url);
              uploadBtn.prop('disabled', false).text('Upload');
              alert('Image uploaded successfully!');
            } else {
              alert('Upload failed: ' + (response.message || 'Unknown error'));
              uploadBtn.prop('disabled', false).text('Upload');
            }
          },
          error: function(xhr, status, error) {
            let errorMessage = 'Upload error: ' + error;
            if (xhr.responseJSON && xhr.responseJSON.message) {
              errorMessage = 'Upload error: ' + xhr.responseJSON.message;
            }
            alert(errorMessage);
            uploadBtn.prop('disabled', false).text('Upload');
          }
        });
      });
      
      // Update preview when URL is manually entered
      imageInput.on('blur', function() {
        const url = $(this).val();
        if (url && (url.startsWith('http') || url.startsWith('/'))) {
          previewImg.attr('src', url);
          preview.removeClass('hidden');
        } else if (!url) {
          preview.addClass('hidden');
        }
      });
      
      // Show preview if there's existing image
      const existingImage = imageInput.val();
      if (existingImage) {
        previewImg.attr('src', existingImage);
        preview.removeClass('hidden');
      }
    }
    
    // Initialize publish time selector
    function initPublishTime() {
      const publishTimeInput = document.getElementById('publishTime');
      const createTimeHidden = document.getElementById('blog-createTime');
      
      if (!publishTimeInput || !createTimeHidden) return;
      
      // Get createTime from hidden field (if exists)
      const createTimeStr = createTimeHidden.value;
      if (createTimeStr && createTimeStr.trim() !== '') {
        try {
          // Convert backend datetime string (yyyy-MM-dd HH:mm:ss) to datetime-local format (YYYY-MM-DDTHH:mm)
          // Parse format: yyyy-MM-dd HH:mm:ss
          const parts = createTimeStr.trim().split(' ');
          if (parts.length === 2) {
            const datePart = parts[0]; // yyyy-MM-dd
            const timePart = parts[1]; // HH:mm:ss
            const timeOnly = timePart.substring(0, 5); // HH:mm
            const datetimeLocal = `${datePart}T${timeOnly}`;
            publishTimeInput.value = datetimeLocal;
          }
        } catch (e) {
          console.error('Failed to parse createTime:', e);
        }
      }
    }
    
    // Flag dropdown functionality
    function initFlagDropdown() {
      const trigger = document.getElementById('flag-trigger');
      const options = document.getElementById('flag-options');
      const arrow = document.getElementById('flag-arrow');
      const display = document.getElementById('flag-display');
      const hiddenSelect = document.getElementById('flag-select-hidden');
      
      // Get selected flag from backend (edit mode)
      const selectedFlagValue = hiddenSelect ? hiddenSelect.value : '原创';
      const flagMap = {
        '原创': 'Original',
        '转载': 'Repost',
        '翻译': 'Translation'
      };
      const selectedFlagDisplay = flagMap[selectedFlagValue] || 'Original';
      if (selectedFlagDisplay) {
        display.textContent = selectedFlagDisplay;
      }
      
      // Click trigger to open/close dropdown
      trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = !options.classList.contains('hidden');
        
        if (isOpen) {
          closeFlagDropdown();
        } else {
          openFlagDropdown();
        }
      });
      
      // Click option
      options.querySelectorAll('.custom-select-option').forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          const value = this.getAttribute('data-value');
          const displayText = this.getAttribute('data-display');
          selectFlag(value, displayText);
          closeFlagDropdown();
        });
      });
      
      // Click outside to close dropdown
      document.addEventListener('click', function(e) {
        if (!trigger.contains(e.target) && !options.contains(e.target)) {
          closeFlagDropdown();
        }
      });
      
      function openFlagDropdown() {
        options.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        trigger.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
      }
      
      function closeFlagDropdown() {
        options.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        trigger.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
      }
    }
    
    // Select flag
    function selectFlag(value, displayText) {
      const display = document.getElementById('flag-display');
      const hiddenSelect = document.getElementById('flag-select-hidden');
      
      if (hiddenSelect) {
        hiddenSelect.value = value; // Store Chinese value for backend
      }
      
      display.textContent = displayText || value; // Display English text
    }

    // Category dropdown functionality
    function initTypeDropdown() {
      const trigger = document.getElementById('type-trigger');
      const options = document.getElementById('type-options');
      const arrow = document.getElementById('type-arrow');
      const display = document.getElementById('type-display');
      const hiddenSelect = document.getElementById('type-select-hidden');
      
      // Get selected category from backend (edit mode)
      const selectedTypeId = hiddenSelect ? hiddenSelect.value : '';
      if (selectedTypeId) {
        const selectedOption = hiddenSelect.querySelector(`option[value="${selectedTypeId}"]`);
        if (selectedOption) {
          display.textContent = selectedOption.textContent;
          display.classList.remove('text-gray-500');
          display.classList.add('text-gray-900');
        }
      }
      
      // Click trigger to open/close dropdown
      trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = !options.classList.contains('hidden');
        
        if (isOpen) {
          closeTypeDropdown();
        } else {
          openTypeDropdown();
        }
      });
      
      // Click option
      options.querySelectorAll('.custom-select-option').forEach(option => {
        option.addEventListener('click', function(e) {
          e.stopPropagation();
          const value = this.getAttribute('data-value');
          const name = this.getAttribute('data-name') || this.textContent.trim();
          selectType(value, name);
          closeTypeDropdown();
        });
      });
      
      // Click outside to close dropdown
      document.addEventListener('click', function(e) {
        if (!trigger.contains(e.target) && !options.contains(e.target)) {
          closeTypeDropdown();
        }
      });
      
      function openTypeDropdown() {
        options.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        trigger.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
      }
      
      function closeTypeDropdown() {
        options.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        trigger.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
      }
    }
    
    // Select category
    function selectType(value, name) {
      const display = document.getElementById('type-display');
      const hiddenSelect = document.getElementById('type-select-hidden');
      
      if (hiddenSelect) {
        hiddenSelect.value = value;
      }
      
      if (value) {
        display.textContent = name || hiddenSelect.querySelector(`option[value="${value}"]`)?.textContent || '';
        display.classList.remove('text-gray-500');
        display.classList.add('text-gray-900');
      } else {
        display.textContent = 'Select category';
        display.classList.remove('text-gray-900');
        display.classList.add('text-gray-500');
      }
    }

    // Tag multi-select dropdown functionality
    function initTagDropdown() {
      const trigger = document.getElementById('tag-trigger');
      const options = document.getElementById('tag-options');
      const arrow = document.getElementById('tag-arrow');
      const display = document.getElementById('tag-selected-display');
      const placeholder = document.getElementById('tag-placeholder');
      const hiddenSelect = document.getElementById('tagIds-hidden');
      
      // Get selected tags from backend (edit mode)
      const selectedTagIds = [];
      
      // Method 1: Get from hidden multi-select
      if (hiddenSelect) {
        Array.from(hiddenSelect.options).forEach(option => {
          if (option.selected) {
            selectedTagIds.push(option.value);
          }
        });
      }
      
      // Method 2: Get from blog.tagIds string
      if (!selectedTagIds.length) {
        const blogTagIdsInput = document.getElementById('blog-tagIds');
        if (blogTagIdsInput && blogTagIdsInput.value) {
          const tagIdsStr = blogTagIdsInput.value.trim();
          if (tagIdsStr) {
            tagIdsStr.split(',').forEach(id => {
              const trimmedId = id.trim();
              if (trimmedId) {
                selectedTagIds.push(trimmedId);
              }
            });
          }
        }
      }
      
      // Initialize selected tags
      selectedTagIds.forEach(tagId => {
        const checkbox = options.querySelector(`.tag-checkbox[value="${tagId}"]`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });
      
      // Update display
      updateTagDisplay();
      
      // Click trigger to open/close dropdown
      trigger.addEventListener('click', function(e) {
        e.stopPropagation();
        const isOpen = !options.classList.contains('hidden');
        
        if (isOpen) {
          closeTagDropdown();
        } else {
          openTagDropdown();
        }
      });
      
      // Click outside to close dropdown
      document.addEventListener('click', function(e) {
        if (!trigger.contains(e.target) && !options.contains(e.target)) {
          closeTagDropdown();
        }
      });
      
      function openTagDropdown() {
        options.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
        trigger.classList.add('ring-2', 'ring-blue-500', 'border-blue-500');
      }
      
      function closeTagDropdown() {
        options.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
        trigger.classList.remove('ring-2', 'ring-blue-500', 'border-blue-500');
      }
      
      // Update tag display
      window.updateTagDisplay = function() {
        const checkboxes = options.querySelectorAll('.tag-checkbox:checked');
        display.innerHTML = '';
        
        if (checkboxes.length === 0) {
          placeholder.style.display = 'inline';
        } else {
          placeholder.style.display = 'none';
          checkboxes.forEach(checkbox => {
            const option = checkbox.closest('.custom-multiselect-option');
            const tagName = option.getAttribute('data-tag-name') || option.querySelector('span').textContent;
            const tagId = checkbox.value;
            
            const tagBadge = document.createElement('span');
            tagBadge.className = 'inline-flex items-center px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mr-1';
            tagBadge.innerHTML = `
              ${tagName}
              <button type="button" 
                      class="ml-1 inline-flex items-center justify-center w-3 h-3 text-blue-600 hover:text-blue-800 rounded-full hover:bg-blue-200 transition-colors"
                      onclick="removeTag('${tagId}')">
                <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            `;
            display.appendChild(tagBadge);
          });
        }
      };
    }
    
    // Toggle tag selection
    function toggleTag(checkbox) {
      const hiddenSelect = document.getElementById('tagIds-hidden');
      const option = hiddenSelect.querySelector(`option[value="${checkbox.value}"]`);
      
      if (checkbox.checked) {
        if (option) option.selected = true;
      } else {
        if (option) option.selected = false;
      }
      
      updateTagDisplay();
    }
    
    // Remove tag
    function removeTag(tagId) {
      const checkbox = document.querySelector(`.tag-checkbox[value="${tagId}"]`);
      if (checkbox) {
        checkbox.checked = false;
        toggleTag(checkbox);
      }
    }

    // Before form submission, combine selected tag IDs into a string
    function prepareTagIdsForSubmit() {
      const selectedTagIds = [];
      document.querySelectorAll('.tag-checkbox:checked').forEach(checkbox => {
        selectedTagIds.push(checkbox.value);
      });
      
      // Combine selected tag IDs into "1,2,3" format string
      const tagIdsString = selectedTagIds.join(',');
      
      // Create or update hidden input to store tagIds string
      let tagIdsInput = document.querySelector('input[name="tagIds"][type="hidden"]');
      if (!tagIdsInput) {
        tagIdsInput = document.createElement('input');
        tagIdsInput.type = 'hidden';
        tagIdsInput.name = 'tagIds';
        document.getElementById('blog-form').appendChild(tagIdsInput);
      }
      tagIdsInput.value = tagIdsString;
    }
    
    // Ensure updateTagDisplay is globally available
    if (typeof updateTagDisplay === 'undefined') {
      window.updateTagDisplay = function() {
        const display = document.getElementById('tag-selected-display');
        const placeholder = document.getElementById('tag-placeholder');
        const options = document.getElementById('tag-options');
        if (!display || !placeholder || !options) return;
        
        const checkboxes = options.querySelectorAll('.tag-checkbox:checked');
        display.innerHTML = '';
        
        if (checkboxes.length === 0) {
          placeholder.style.display = 'inline';
        } else {
          placeholder.style.display = 'none';
          checkboxes.forEach(checkbox => {
            const option = checkbox.closest('.custom-multiselect-option');
            const tagName = option.getAttribute('data-tag-name') || option.querySelector('span').textContent;
            const tagId = checkbox.value;
            
            const tagBadge = document.createElement('span');
            tagBadge.className = 'inline-flex items-center px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-800 rounded-full mr-1';
            tagBadge.innerHTML = `
              ${tagName}
              <button type="button" 
                      class="ml-1 inline-flex items-center justify-center w-3 h-3 text-blue-600 hover:text-blue-800 rounded-full hover:bg-blue-200 transition-colors"
                      onclick="removeTag('${tagId}')">
                <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
              </button>
            `;
            display.appendChild(tagBadge);
          });
        }
      };
    }

    $('#save-btn').click(function () {
      $('[name="published"]').val(false);
      if (validateForm()) {
        prepareTagIdsForSubmit();
      $('#blog-form').submit();
      }
    });

    $('#publish-btn').click(function () {
      $('[name="published"]').val(true);
      if (validateForm()) {
        prepareTagIdsForSubmit();
      $('#blog-form').submit();
      }
    });

    function validateForm() {
      const title = $('[name="title"]').val();
      const content = contentEditor ? contentEditor.getMarkdown() : '';
      const typeId = $('[name="type.id"]').val();
      const firstPicture = $('[name="firstPicture"]').val();
      const description = $('[name="description"]').val();
      
      const errorMsg = $('#error-message');
      const errorText = errorMsg.find('p');
      
      if (!title || title.trim() === '') {
        errorText.text('Please enter blog title');
        errorMsg.removeClass('hidden');
        return false;
      }
      
      if (!content || content.trim() === '') {
        errorText.text('Please enter blog content');
        errorMsg.removeClass('hidden');
        return false;
      }
      
      if (!typeId) {
        errorText.text('Please select blog category');
        errorMsg.removeClass('hidden');
        return false;
      }
      
      // First picture is optional - will extract from content if not provided
      // No validation needed for firstPicture
      
      // Description and location are optional, no validation needed
      
      errorMsg.addClass('hidden');
      return true;
    }

  </script>
</body>
</html>
